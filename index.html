<html>
	<head>
		<title>Can't Complain Birds</title>
		<style type="text/css">
		div {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		#debug {
			font-family: sans-serif;
			font-size: 25px;
		}
		#gamewrap {
			//background-color: gray;
			width: 1280px;
			height: 800px;
			position: fixed;
			top: 7px;
			z-index = -2;
			overflow: hidden;
		}
		#cannon {
			position: fixed;
			top: 725px;
		}
		#cannon-body {
			-webkit-transform-origin: 27% 70%;
			position: absolute;
			width: 100;
			top: 22px;
			left: 15px;
			z-index: 2;
		}
		#cannon-base {
			position: absolute;
			width: 70px;
			top: 52px;
			left: 20px;
			z-index: 3;
		}
		.marker {
			position: absolute;
			width: 15px;
			z-index: 1;
		}
		.box {
			position: absolute;
			background: red;
			opacity: 1;
		}
		.tempBox {
			position: fixed;
			background: red;
			opacity: 0.5;
		}
		.staticBox {
			position: fixed;
			background: black;
			opacity: 1;
		}
		</style>
	</head>
	<body>
		<canvas id="canvas" width="1280" height="800"></canvas>
		<div id="gamewrap"><div id="markers"></div></div>
		<div id="cannon">
			<img id="cannon-body" src="img/cannon-body.png"></img>
			<img id="cannon-base" src="img/cannon-base.png"></img>
		</div>
		
		<div id="debug"></div>
		<div id="shotMarker"></div>
		<input type="range" name="widthSlider" id="widthSlider" value="50" min="2" max="300" onchange="changeBoxHeight(this.value)">
		<input type="range" name="heightSlider" id="heightSlider" value="50" min="2" max="300" onchange="changeBoxWidth(this.value)">
	</body>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script type="text/javascript" src="js/Box2dWeb-2.1.a.3.min.js"></script>
	<script type="text/javascript">
		var frameRate = 60;
		var numberOfMarkers = 20;
		var markers = [];
		
		var worldWidth = 1280;
		var worldHeight = 800;
		var wallsWidth = 2;
		var PhysicsToCSSOffset = 8;
			
		var worldScale = 30;
		var physicalBoxes = [];
		var offsetX = [];
		var offsetY = [];
		var startboxSizeX = 50;
		var startboxSizeY = 50;
		var boxBorder = 2;
		var tempBoxDiv = new Box();
		
		var b2Vec2 = Box2D.Common.Math.b2Vec2;
		var b2AABB = Box2D.Collision.b2AABB;
		var b2BodyDef = Box2D.Dynamics.b2BodyDef;
		var b2Body = Box2D.Dynamics.b2Body;
		var b2FixtureDef = Box2D.Dynamics.b2FixtureDef;
		var b2Fixture = Box2D.Dynamics.b2Fixture;
		var b2World = Box2D.Dynamics.b2World;
		var b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape;
		var b2DebugDraw = Box2D.Dynamics.b2DebugDraw;
		var world = new b2World(new b2Vec2(0, 10),true);
			
		var mouseDown;
		var cannonPower = 100;
		
		$(document).ready(function() {
			init();
		})
		
		function init() {
			debugDraw();
			createMarkers();			
			
			var boundingBox1 = new Box((worldWidth*0.5), worldHeight, worldWidth, wallsWidth);
			var boundingBox2 = new Box((worldWidth*0.5), 0, worldWidth, wallsWidth);
			var boundingBox3 = new Box(0, (worldHeight*0.5), wallsWidth, worldHeight);
			var boundingBox4 = new Box(worldWidth, (worldHeight*0.5), wallsWidth, worldHeight);
			
			createBox(boundingBox1, b2Body.b2_staticBody);
			createBox(boundingBox2, b2Body.b2_staticBody);
			createBox(boundingBox3, b2Body.b2_staticBody);
			createBox(boundingBox4, b2Body.b2_staticBody);
			
			window.setInterval(update,1000/frameRate);
		}
		
		function update() {
			if (keyisdown) {
				world.Step(1/600,10,10);
			} else {
				world.Step(1/frameRate*2,10,10);
			}
			world.DrawDebugData();
			var i = physicalBoxes.length-1;
			for (var b = world.GetBodyList(); b; b = b.GetNext())
			{
				if (b.GetNext() != null && b.GetType() == 2)
				{
					physicalBoxes[i].style.top = ((b.GetPosition().y*worldScale))-(parseInt(physicalBoxes[i].style.width)/2)+"px";
					physicalBoxes[i].style.left = ((b.GetPosition().x*worldScale))-(parseInt(physicalBoxes[i].style.height)/2)+"px";
					physicalBoxes[i].style.webkitTransform = "rotate("+(b.GetAngle()*(180/Math.PI))+"deg)";
				}
				i--;
			}
			//console.log(world.GetBodyCount());
			world.ClearForces();
		}
		
		// -------------------------------- EVENT LISTENERS START -------------------------------- //
		document.addEventListener("mouseup",function(e) {
			if (mouseDown)
			{
				spawnBox(tempBoxDiv);
				mouseDown = false;
			}
		});
		
		document.getElementById("gamewrap").addEventListener("mousedown",function(e) {
			mouseDown = true;
			createTempBox(e.clientX, e.clientY, startboxSizeX, startboxSizeY);
		});
		
		document.getElementById("gamewrap").addEventListener("mousemove",function(e) {
			updateMarkers(e);
			if (mouseDown)
			{
				updateTempBox(e.clientX, e.clientY);
			}
		});
		
		document.getElementById("gamewrap").addEventListener("mousewheel", function(e) {
			var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
			cannonPower += delta;
			updateMarkers(e);
		});
		// --------------------------------  EVENT LISTENERS END  -------------------------------- //
		
		function createMarkers() {
			for (var i=0; i < numberOfMarkers; i++)
			{
				var img = document.createElement("img");
				img.className = "marker";
				img.src = "img/marker.png";
				document.getElementById("markers").appendChild(img);
				markers.push(img);
			}
		}
		
		function updateMarkers(e) {
			var cannonOrigin = { x:50, y:777 };
			var mouseOrigin = { x:e.clientX, y:e.clientY };
			var deltaX = (mouseOrigin.x-cannonOrigin.x);
			var deltaY = (mouseOrigin.y-cannonOrigin.y);
			var angleInRadians =  Math.atan(deltaY / deltaX);
			var angleInDegrees = angleInRadians * 180 / Math.PI;
			//var shotMarker = document.getElementById("shotMarker");
			var cannonBody = document.getElementById("cannon-body");
			//shotMarker.style.left = cannonOrigin.x+"px";
			//shotMarker.style.top = cannonOrigin.y+"px";
			//shotMarker.style.width = (Math.sqrt(Math.pow(deltaX,2)+Math.pow(deltaY,2))-3)+"px";
			//shotMarker.style.width = cannonPower+"px";
			//shotMarker.style.height = 2+"px";
			//shotMarker.style.transform = 'rotate('+angleInDegrees+'deg)';
			cannonBody.style.transform = 'rotate('+angleInDegrees+'deg)';
			for (var i = 0; i < markers.length; i++)
			{
				markers[i].style.left = cannonOrigin.x+(cannonPower*i*Math.cos(-angleInRadians))-7.5+"px";
				markers[i].style.top = cannonOrigin.y-((cannonPower*i*Math.sin(-angleInRadians))-0.5*9.8*(Math.pow(i,2)))-7.5+"px";
			}
		}
		
		function changeBoxWidth(value) {
			startboxSizeX = value;
		}
		
		function changeBoxHeight(value) {
			startboxSizeY = value;
		}
		
		function Box(xPos, yPos, width, height) {
			this.x = xPos;
			this.y = yPos;
			this.width = width;
			this.height = height;
			this.div = null;
		}
		
		function createTempBox(xPos, yPos, width, height) {
			var div = document.createElement("div");
			div.className = "tempBox";
			div.style.left = (xPos - PhysicsToCSSOffset)-(width/2)+PhysicsToCSSOffset+"px";
			div.style.top =  (yPos - PhysicsToCSSOffset)-(height/2)+PhysicsToCSSOffset+"px";
			div.style.width = (width-boxBorder)+"px";
			div.style.height = (height-boxBorder)+"px";
			div.style.border = boxBorder+"px solid black";
			document.getElementById("gamewrap").appendChild(div);
			tempBoxDiv.x = xPos;
			tempBoxDiv.y = yPos;
			tempBoxDiv.width = width;
			tempBoxDiv.height = height;
			tempBoxDiv.div = div;
		}
		
		function updateTempBox(xPos, yPos) {
			tempBoxDiv.x = xPos;
			tempBoxDiv.y = yPos;
			tempBoxDiv.div.style.left = (xPos - PhysicsToCSSOffset)-(tempBoxDiv.width/2)+PhysicsToCSSOffset+"px";
			tempBoxDiv.div.style.top =  (yPos - PhysicsToCSSOffset)-(tempBoxDiv.height/2)+PhysicsToCSSOffset+"px";
		}
		
		function spawnBox(box) {
			var boxSizeX = startboxSizeX;
			var boxSizeY = startboxSizeY;
			var randomX = Math.random()*0;
			var randomY = Math.random()*0;
			boxSizeX += randomX;
			boxSizeY += randomY;
			box.x = (box.x-PhysicsToCSSOffset);
			box.y = (box.y-PhysicsToCSSOffset);
			createBox(box, b2Body.b2_dynamicBody);
		}
		
		function createBox(box, type) {
			var bodyDef = new b2BodyDef;
			bodyDef.type = type;
			bodyDef.position.Set(box.x/worldScale,box.y/worldScale);
			var polygonShape = new b2PolygonShape;
			polygonShape.SetAsBox(box.width/2/worldScale,box.height/2/worldScale);
			var fixtureDef = new b2FixtureDef;
			fixtureDef.density = 1.0;
			fixtureDef.friction = 0.6;
			fixtureDef.restitution = 0.1;
			fixtureDef.shape = polygonShape;
			var body=world.CreateBody(bodyDef);
			body.CreateFixture(fixtureDef);
			if (type != b2Body.b2_staticBody)
			{
				releaseBox(box);
			} else {
				createDiv(box);
			}
		}
		
		function releaseBox(box) {
			//var div = document.createElement("div");
			box.div.className = "box";
			document.getElementById("gamewrap").appendChild(box.div);
			physicalBoxes.push(box.div);
			offsetX.push(-(box.width-(box.width/2))+PhysicsToCSSOffset);
			offsetY.push(-(box.height-(box.height/2))+PhysicsToCSSOffset);
		}
		
		function createDiv(box) {
			var div = document.createElement("div");
			div.className = "staticBox";
			div.style.top = (box.y-(box.height/2)+PhysicsToCSSOffset)+"px";
			div.style.left = (box.x-(box.width/2)+PhysicsToCSSOffset)+"px";
			div.style.width = box.width+"px";
			div.style.height = box.height+"px";
			document.getElementById("gamewrap").appendChild(div);
		}
		
		function debugDraw(){
			var debugDraw = new b2DebugDraw();
			debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
			debugDraw.SetDrawScale(30.0);
			debugDraw.SetFillAlpha(1.0);
			debugDraw.SetLineThickness(5.0);
			debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
			world.SetDebugDraw(debugDraw);
		}
		
		var keyisdown = false;
		$('body').bind('keydown',function(e){
			var keycode = 73;
			if (e.which === keycode) {
				keyisdown = true;
			}
		}).bind('keyup',function(){
			keyisdown = false;
		});
		
	</script>
</html>